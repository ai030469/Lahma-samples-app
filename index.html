import React, { useState } from 'react';
import { Download, Mail, CheckCircle, AlertCircle } from 'lucide-react';

const OrderForm = () => {
  const [formData, setFormData] = useState({
    customerName: '',
    fillDate: '',
    pickupDate: '',
    pickupTime: '',
    ordererName: '',
    products: Array(16).fill(null).map((_, index) => ({
      id: index + 1,
      code: '',
      name: '',
      quantity: '',
      status: ''
    }))
  });

  const [errors, setErrors] = useState({});
  const [showOutput, setShowOutput] = useState(false);

  const productStatuses = [
    'אפוי',
    'קפוא', 
    'טרי',
    'מיובש',
    'מבושל',
    'גלם'
  ];

  const timeOptions = [];
  for (let hour = 6; hour <= 22; hour++) {
    for (let min = 0; min < 60; min += 30) {
      const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
      timeOptions.push(timeStr);
    }
  }

  const handleInputChange = (field, value) => {
    setFormData(prev => ({
      ...prev,
      [field]: value
    }));
    
    if (errors[field]) {
      setErrors(prev => ({
        ...prev,
        [field]: false
      }));
    }
  };

  const handleProductChange = (index, field, value) => {
    setFormData(prev => ({
      ...prev,
      products: prev.products.map((product, i) => 
        i === index ? { ...product, [field]: value } : product
      )
    }));
  };

  const validateForm = () => {
    const newErrors = {};
    
    if (!formData.customerName.trim()) newErrors.customerName = true;
    if (!formData.fillDate) newErrors.fillDate = true;
    if (!formData.pickupDate) newErrors.pickupDate = true;
    if (!formData.pickupTime) newErrors.pickupTime = true;
    if (!formData.ordererName.trim()) newErrors.ordererName = true;
    
    // Check if pickup date is after fill date
    if (formData.fillDate && formData.pickupDate) {
      const fillDate = new Date(formData.fillDate);
      const pickupDate = new Date(formData.pickupDate);
      if (pickupDate <= fillDate) {
        newErrors.pickupDate = true;
        newErrors.dateOrder = true;
      }
    }
    
    // Check if at least one product is filled
    const hasProducts = formData.products.some(product => 
      product.code.trim() || product.name.trim() || product.quantity || product.status
    );
    
    if (!hasProducts) {
      newErrors.products = true;
    }
    
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSubmit = () => {
    if (validateForm()) {
      setShowOutput(true);
    }
  };

  const generateOutput = () => {
    const filledProducts = formData.products.filter(product => 
      product.code.trim() || product.name.trim() || product.quantity || product.status
    );
    
    let output = `הזמנת דוגמאות - לחמא\n`;
    output += `=====================================\n\n`;
    output += `שם הלקוח: ${formData.customerName}\n`;
    output += `תאריך מילוי: ${new Date(formData.fillDate).toLocaleDateString('he-IL')}\n`;
    output += `תאריך איסוף מתוכנן: ${new Date(formData.pickupDate).toLocaleDateString('he-IL')}\n`;
    output += `שעת איסוף מבוקשת: ${formData.pickupTime}\n`;
    output += `שם המזמין: ${formData.ordererName}\n\n`;
    output += `רשימת מוצרים:\n`;
    output += `================\n`;
    
    filledProducts.forEach(product => {
      output += `${product.id}. מק"ט: ${product.code} | שם: ${product.name} | כמות: ${product.quantity} | מצב: ${product.status}\n`;
    });
    
    return output;
  };

  const downloadFile = () => {
    const output = generateOutput();
    const blob = new Blob([output], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const fileName = `הזמנה_${formData.customerName}_${formData.fillDate}.txt`;
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  const sendEmail = () => {
    const output = generateOutput();
    const subject = encodeURIComponent(`הזמנת דוגמאות - ${formData.customerName}`);
    const body = encodeURIComponent(output);
    window.open(`mailto:?subject=${subject}&body=${body}`);
  };

  if (showOutput) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-4">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-xl shadow-xl p-8">
            <div className="text-center mb-8">
              <h1 className="text-4xl font-bold text-orange-600 mb-2">לחמא</h1>
              <h2 className="text-2xl text-gray-700">סיכום הזמנה</h2>
            </div>
            
            <div className="bg-gray-50 rounded-lg p-6 mb-6">
              <pre className="whitespace-pre-wrap text-right text-gray-800 leading-relaxed">
                {generateOutput()}
              </pre>
            </div>
            
            <div className="flex gap-4 justify-center">
              <button
                onClick={downloadFile}
                className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors"
              >
                <Download size={20} />
                הורד קובץ
              </button>
              
              <button
                onClick={sendEmail}
                className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition-colors"
              >
                <Mail size={20} />
                שלח במייל
              </button>
              
              <button
                onClick={() => setShowOutput(false)}
                className="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition-colors"
              >
                חזור לעריכה
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50 p-4">
      <div className="max-w-6xl mx-auto">
        <div className="bg-white rounded-xl shadow-xl overflow-hidden">
          {/* Header */}
          <div className="bg-gradient-to-r from-orange-600 to-amber-600 text-white p-8 text-center">
            <h1 className="text-5xl font-bold mb-2">לחמא</h1>
            <h2 className="text-2xl opacity-90">מערכת הזמנת דוגמאות</h2>
          </div>

          <div className="p-8">
            {/* Customer Details */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-gray-800 mb-4 text-right">פרטים כלליים</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1 text-right">
                    שם הלקוח *
                  </label>
                  <input
                    type="text"
                    value={formData.customerName}
                    onChange={(e) => handleInputChange('customerName', e.target.value)}
                    className={`w-full p-3 border rounded-lg text-right ${
                      errors.customerName ? 'border-red-500 bg-red-50' : 'border-gray-300'
                    } focus:ring-2 focus:ring-orange-500 focus:border-transparent`}
                    placeholder="הזן שם לקוח"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1 text-right">
                    תאריך מילוי *
                  </label>
                  <input
                    type="date"
                    value={formData.fillDate}
                    onChange={(e) => handleInputChange('fillDate', e.target.value)}
                    className={`w-full p-3 border rounded-lg ${
                      errors.fillDate ? 'border-red-500 bg-red-50' : 'border-gray-300'
                    } focus:ring-2 focus:ring-orange-500 focus:border-transparent`}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1 text-right">
                    תאריך איסוף מתוכנן *
                  </label>
                  <input
                    type="date"
                    value={formData.pickupDate}
                    onChange={(e) => handleInputChange('pickupDate', e.target.value)}
                    className={`w-full p-3 border rounded-lg ${
                      errors.pickupDate ? 'border-red-500 bg-red-50' : 'border-gray-300'
                    } focus:ring-2 focus:ring-orange-500 focus:border-transparent`}
                  />
                  {errors.dateOrder && (
                    <p className="text-red-500 text-sm mt-1 text-right">תאריך האיסוף חייב להיות אחרי תאריך המילוי</p>
                  )}
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1 text-right">
                    שעת איסוף מבוקשת *
                  </label>
                  <select
                    value={formData.pickupTime}
                    onChange={(e) => handleInputChange('pickupTime', e.target.value)}
                    className={`w-full p-3 border rounded-lg ${
                      errors.pickupTime ? 'border-red-500 bg-red-50' : 'border-gray-300'
                    } focus:ring-2 focus:ring-orange-500 focus:border-transparent`}
                  >
                    <option value="">בחר שעה</option>
                    {timeOptions.map(time => (
                      <option key={time} value={time}>{time}</option>
                    ))}
                  </select>
                </div>

                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700 mb-1 text-right">
                    שם המזמין *
                  </label>
                  <input
                    type="text"
                    value={formData.ordererName}
                    onChange={(e) => handleInputChange('ordererName', e.target.value)}
                    className={`w-full p-3 border rounded-lg text-right ${
                      errors.ordererName ? 'border-red-500 bg-red-50' : 'border-gray-300'
                    } focus:ring-2 focus:ring-orange-500 focus:border-transparent`}
                    placeholder="הזן שם המזמין"
                  />
                </div>
              </div>
            </div>

            {/* Products Table */}
            <div className="mb-8">
              <h3 className="text-xl font-semibold text-gray-800 mb-4 text-right">רשימת מוצרים</h3>
              {errors.products && (
                <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                  <p className="text-red-600 text-right flex items-center gap-2">
                    <AlertCircle size={16} />
                    יש למלא לפחות מוצר אחד
                  </p>
                </div>
              )}
              
              <div className="overflow-x-auto border border-gray-200 rounded-lg">
                <table className="min-w-full">
                  <thead className="bg-gradient-to-r from-orange-100 to-amber-100">
                    <tr>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b">מס'</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b">מק"ט</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b">שם המוצר</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b">כמות</th>
                      <th className="px-4 py-3 text-right text-sm font-semibold text-gray-700 border-b">מצב המוצר</th>
                    </tr>
                  </thead>
                  <tbody>
                    {formData.products.map((product, index) => (
                      <tr key={product.id} className="hover:bg-gray-50 transition-colors">
                        <td className="px-4 py-3 text-center font-medium text-gray-600 border-b">
                          {product.id}
                        </td>
                        <td className="px-4 py-3 border-b">
                          <input
                            type="text"
                            value={product.code}
                            onChange={(e) => handleProductChange(index, 'code', e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded text-right focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            placeholder="מק"ט"
                          />
                        </td>
                        <td className="px-4 py-3 border-b">
                          <input
                            type="text"
                            value={product.name}
                            onChange={(e) => handleProductChange(index, 'name', e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded text-right focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            placeholder="שם המוצר"
                          />
                        </td>
                        <td className="px-4 py-3 border-b">
                          <input
                            type="number"
                            value={product.quantity}
                            onChange={(e) => handleProductChange(index, 'quantity', e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded text-right focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                            placeholder="כמות"
                            min="0"
                          />
                        </td>
                        <td className="px-4 py-3 border-b">
                          <select
                            value={product.status}
                            onChange={(e) => handleProductChange(index, 'status', e.target.value)}
                            className="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                          >
                            <option value="">בחר מצב</option>
                            {productStatuses.map(status => (
                              <option key={status} value={status}>{status}</option>
                            ))}
                          </select>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Submit Button */}
            <div className="text-center">
              <button
                onClick={handleSubmit}
                className="bg-gradient-to-r from-orange-600 to-amber-600 text-white px-8 py-4 rounded-lg font-semibold text-lg hover:from-orange-700 hover:to-amber-700 transition-all duration-200 shadow-lg hover:shadow-xl transform hover:-translate-y-1"
              >
                <CheckCircle className="inline-block mr-2" size={20} />
                צור הזמנה
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  }
};

export default OrderForm;
